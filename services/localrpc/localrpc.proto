syntax = "proto3";

package services.localrpc;

option go_package = "github.com/chainreactors/IoM-go/proto/services/localrpc";

// CommandService provides gRPC methods for executing commands and Lua scripts
// in the context of the Malice Network C2 client
service CommandService {
  // ExecuteCommand executes a client command in the specified session context
  // Commands are automatically routed to client menu or implant menu based on
  // whether there's an active session
  rpc ExecuteCommand(ExecuteCommandRequest) returns (ExecuteCommandResponse);

  // ExecuteLua executes a Lua script with access to internal functions and
  // the current session context
  rpc ExecuteLua(ExecuteLuaRequest) returns (ExecuteLuaResponse);

  // GetHistory retrieves rendered history data for a specific task
  rpc GetHistory(GetHistoryRequest) returns (GetHistoryResponse);

  // GetSchemas retrieves JSON schemas for commands in specified cobra group
  // Returns schemas suitable for react-jsonschema-form rendering
  rpc GetSchemas(GetSchemasRequest) returns (GetSchemasResponse);

  // GetGroups retrieves information about all available command groups
  rpc GetGroups(GetGroupsRequest) returns (GetGroupsResponse);
}

// ExecuteCommandRequest contains the command to execute and optional session context
message ExecuteCommandRequest {
  // The command to execute, exactly as you would type it in the console
  // Examples:
  // - "session --all --static" - List all sessions
  // - "use <session_id>" - Switch to a session
  // - "whoami" - Execute whoami in current session (requires active session)
  // - "ls" - List files in current directory (requires active session)
  string command = 1;

  // Optional session ID to set as active context before execution
  // If not provided, uses the current active session
  string session_id = 2;
}

// ExecuteCommandResponse contains the result of command execution
message ExecuteCommandResponse {
  // The output from the command execution
  string output = 1;

  // Error message if the command failed
  string error = 2;

  // Whether the command executed successfully
  bool success = 3;
}

// ExecuteLuaRequest contains the Lua script to execute and optional session context
message ExecuteLuaRequest {
  // Lua script code to execute
  // The script has access to:
  // - session: current session object
  // - session_id: current session ID
  // - console: console object
  // - All registered internal functions
  string script = 1;

  // Optional session ID to set as active context before execution
  // If provided, the session context will be switched before script execution
  // and restored after execution completes
  string session_id = 2;
}

// ExecuteLuaResponse contains the result of Lua script execution
message ExecuteLuaResponse {
  // The output/return value from the Lua script execution
  string output = 1;

  // Error message if the script failed
  string error = 2;

  // Whether the script executed successfully
  bool success = 3;
}

// GetHistoryRequest contains the task ID to query
message GetHistoryRequest {
  // Task ID to retrieve history for
  uint32 task_id = 1;

  // Session ID context
  string session_id = 2;
}

// GetHistoryResponse contains the rendered history data
message GetHistoryResponse {
  // Rendered output for the task
  string output = 1;

  // Error message if retrieval failed
  string error = 2;

  // Whether the operation was successful
  bool success = 3;
}

// GetSchemasRequest contains the cobra group to query
message GetSchemasRequest {
  // Cobra command group to retrieve schemas for
  // Examples: "implant", "execute", "sys", "file", "pivot"
  // Required field
  string group = 1;
}

// GetSchemasResponse contains the JSON schemas for commands
message GetSchemasResponse {
  // JSON string containing schemas for commands in the specified group
  // Format: { "group_name": { "command_name": schema } }
  string schemas_json = 1;

  // Error message if retrieval failed
  string error = 2;

  // Whether the operation was successful
  bool success = 3;
}

// GetGroupsRequest contains the request for getting all groups
message GetGroupsRequest {
  // Empty request - returns all available groups
}

// GetGroupsResponse contains information about all available groups
message GetGroupsResponse {
  // Map of group ID to group title
  // Format: { "execute": "Execute", "sys": "System", "file": "File", ... }
  map<string, string> groups = 1;

  // Error message if retrieval failed
  string error = 2;

  // Whether the operation was successful
  bool success = 3;
}
